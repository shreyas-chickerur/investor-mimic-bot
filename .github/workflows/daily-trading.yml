name: Daily Paper Trading

on:
  schedule:
    - cron: '15 21 * * 1-5'  # 4:15 PM ET (9:15 PM UTC) on weekdays - AFTER market close
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.8"

jobs:
  run-paper-trading:
    name: Execute Daily Paper Trading
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore trading database cache
        uses: actions/cache@v4
        with:
          path: trading.db
          key: trading-db-${{ github.run_id }}
          restore-keys: |
            trading-db-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create required directories
        run: |
          mkdir -p logs data

      - name: Run Multi-Strategy Trading System
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          ALPACA_PAPER: "true"
          ENABLE_BROKER_RECONCILIATION: "true"
          PHASE5_SIGNAL_INJECTION: "false"
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          echo "üöÄ Starting multi-strategy trading run..."
          python3 src/multi_strategy_main.py
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-logs-${{ github.run_number }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload databases (timestamped)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-database-${{ github.run_number }}
          path: |
            trading.db
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload databases (latest)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trading-database-latest
          path: |
            trading.db
          retention-days: 90
          if-no-files-found: ignore
      
      - name: Generate Performance Report
        if: success()
        run: |
          echo "üìä Generating strategy performance report..."
          python3 scripts/view_strategy_performance.py > strategy_report.txt
          cat strategy_report.txt
      
      - name: Upload Performance Report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strategy-report-${{ github.run_number }}
          path: strategy_report.txt
          retention-days: 30

      - name: Notify completion
        if: success()
        run: |
          echo "‚úÖ Paper trading run completed successfully"
          
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Paper trading run failed - check logs"
