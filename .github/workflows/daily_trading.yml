name: Daily Trading Execution

on:
  schedule:
    # Runs at 6:30 AM PST (14:30 UTC) every day
    - cron: '30 14 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: "3.8"

jobs:
  daily-execution:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Import check
      run: |
        python3 scripts/import_check.py
    
    - name: Download previous database (if exists)
      uses: actions/download-artifact@v4
      with:
        name: trading-database
        path: .
      continue-on-error: true
    
    - name: Initialize database
      run: |
        python scripts/setup_database.py --db trading.db
    
    - name: Create required directories
      run: |
        mkdir -p artifacts/json artifacts/markdown logs data
    
    - name: Update market data
      env:
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      run: |
        python scripts/fetch_historical_data.py
    
    - name: Safety check - Verify paper trading mode
      env:
        ALPACA_PAPER: 'true'
      run: |
        echo "=== Safety Verification ==="
        if [ "$ALPACA_PAPER" != "true" ]; then
          echo "âŒ FATAL: ALPACA_PAPER must be 'true' for automated runs"
          exit 1
        fi
        echo "âœ… Paper trading mode confirmed"
        
        # Verify PHASE5_SIGNAL_INJECTION is false
        INJECTION="${PHASE5_SIGNAL_INJECTION:-false}"
        if [ "$INJECTION" != "false" ]; then
          echo "âŒ FATAL: PHASE5_SIGNAL_INJECTION must be 'false' for production"
          exit 1
        fi
        echo "âœ… Signal injection disabled (production mode)"
    
    - name: Pre-execution broker state check
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_PAPER: true
      run: |
        python3 scripts/check_broker_state.py
    
    - name: Run daily execution
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_PAPER: 'true'
        ALPACA_LIVE_ENABLED: 'false'
        ENABLE_BROKER_RECONCILIATION: 'true'
        PHASE5_SIGNAL_INJECTION: 'false'
        DATA_MAX_AGE_HOURS: '72'
      run: |
        echo "=== Daily Trading Execution - $(date) ==="
        echo "Environment:"
        echo "  ALPACA_PAPER: $ALPACA_PAPER"
        echo "  ALPACA_LIVE_ENABLED: $ALPACA_LIVE_ENABLED"
        echo "  ENABLE_BROKER_RECONCILIATION: $ENABLE_BROKER_RECONCILIATION"
        echo "  PHASE5_SIGNAL_INJECTION: $PHASE5_SIGNAL_INJECTION"
        echo "  DATA_MAX_AGE_HOURS: $DATA_MAX_AGE_HOURS"
        echo ""
        python3 src/execution_engine.py
    
    - name: Verify reconciliation passed
      run: |
        python3 -c "
        import json
        from datetime import datetime
        from pathlib import Path
        import sys
        
        date = datetime.now().strftime('%Y-%m-%d')
        json_path = Path(f'artifacts/json/{date}.json')
        
        if json_path.exists():
            with open(json_path) as f:
                data = json.load(f)
            
            system_health = data.get('system_health', {})
            recon = system_health.get('reconciliation_status', 'UNKNOWN')
            discrep = system_health.get('reconciliation_discrepancies', [])
            
            print(f'Reconciliation: {recon}')
            print(f'Discrepancies: {len(discrep)}')
            
            if 'PASS' in recon and len(discrep) == 0:
                print('âœ… Execution complete - Reconciliation passed')
                sys.exit(0)
            else:
                print('âŒ Reconciliation failed')
                sys.exit(1)
        else:
            print(f'âŒ No artifact found for {date}')
            sys.exit(1)
        "
    
    - name: Validate system invariants
      run: |
        echo "=== Validating System ==="
        python3 scripts/validate_system.py --latest
    
    - name: Verify execution criteria
      run: |
        echo "=== Verifying Execution ==="
        python3 scripts/verify_execution.py
    
    - name: Extract run metrics
      if: always()
      run: |
        echo "=== Run Metrics ==="
        RUN_ID=$(sqlite3 trading.db "SELECT run_id FROM broker_state ORDER BY created_at DESC LIMIT 1;" || echo "UNKNOWN")
        echo "Run ID: $RUN_ID"
        
        if [ "$RUN_ID" != "UNKNOWN" ]; then
          echo ""
          echo "Broker Snapshots:"
          sqlite3 trading.db "SELECT snapshot_type, reconciliation_status FROM broker_state WHERE run_id='$RUN_ID' ORDER BY created_at;"
          
          echo ""
          echo "Signal Termination:"
          sqlite3 trading.db "SELECT COUNT(*) AS total, SUM(CASE WHEN terminal_state IS NOT NULL THEN 1 ELSE 0 END) AS terminalized FROM signals WHERE run_id='$RUN_ID';"
          
          echo ""
          echo "Terminal States:"
          sqlite3 trading.db "SELECT terminal_state, terminal_reason, COUNT(*) FROM signals WHERE run_id='$RUN_ID' GROUP BY terminal_state, terminal_reason;"
          
          echo ""
          echo "Trades:"
          sqlite3 trading.db "SELECT COUNT(*) FROM trades WHERE run_id='$RUN_ID';"
        fi
    
    - name: Upload trading database
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-database
        path: trading.db
        retention-days: 90
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-artifacts-${{ github.run_number }}
        path: |
          artifacts/
          logs/
        retention-days: 90
    
    - name: Generate strategy performance report
      if: success()
      run: |
        python3 scripts/generate_strategy_performance.py --days 30
    
    - name: Generate strategy performance chart
      if: success()
      run: |
        python3 scripts/generate_strategy_chart.py --days 7
    
    - name: Generate performance chart
      if: success()
      run: |
        python3 scripts/generate_email_chart.py
    
    - name: Generate daily email digest
      if: success()
      run: |
        # Check if today is Mon/Wed/Fri for visual reports
        DAY_OF_WEEK=$(date +%u)  # 1=Mon, 3=Wed, 5=Fri
        if [ "$DAY_OF_WEEK" = "1" ] || [ "$DAY_OF_WEEK" = "3" ] || [ "$DAY_OF_WEEK" = "5" ]; then
          echo "ðŸ“Š Generating email with strategy performance visuals (Mon/Wed/Fri)"
          python3 scripts/generate_daily_email.py --include-visuals
        else
          echo "ðŸ“§ Generating standard daily email"
          python3 scripts/generate_daily_email.py
        fi
    
    - name: Send daily digest email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ðŸ“Š Daily Trading Digest - ${{ github.run_number }}"
        to: ${{ secrets.EMAIL_TO }}
        from: Trading System
        html_body: file:///tmp/daily_email.html
    
    - name: Create GitHub summary
      if: always()
      run: |
        RUN_ID=$(sqlite3 trading.db "SELECT run_id FROM broker_state ORDER BY created_at DESC LIMIT 1;" || echo "UNKNOWN")
        SIGNALS=$(sqlite3 trading.db "SELECT COUNT(*) FROM signals WHERE run_id='$RUN_ID';" || echo "0")
        TRADES=$(sqlite3 trading.db "SELECT COUNT(*) FROM trades WHERE run_id='$RUN_ID';" || echo "0")
        RECON_STATUS=$(sqlite3 trading.db "SELECT reconciliation_status FROM broker_state WHERE run_id='$RUN_ID' AND snapshot_type='RECONCILIATION';" || echo "UNKNOWN")
        
        cat > $GITHUB_STEP_SUMMARY << EOF
        # Daily Trading Execution - $(date +%Y-%m-%d)
        
        **Run ID:** \`$RUN_ID\`  
        **Signals:** $SIGNALS  
        **Trades:** $TRADES  
        **Reconciliation:** $RECON_STATUS  
        **Status:** ${{ job.status }}
        
        ## Validation Checks
        - âœ… Safety: Paper trading mode verified
        - âœ… System Invariants: Validated
        - âœ… Execution Criteria: Verified
        - âœ… Database: Uploaded (90 day retention)
        - âœ… Artifacts: Uploaded (90 day retention)
        
        ## Environment
        - ALPACA_PAPER: true
        - PHASE5_SIGNAL_INJECTION: false
        - ENABLE_BROKER_RECONCILIATION: true
        - DATA_MAX_AGE_HOURS: 72
        
        ## Artifacts
        - Database: \`trading-database\`
        - Daily artifacts: \`daily-artifacts-${{ github.run_number }}\`
        EOF
    
    - name: Send failure notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âš ï¸ Daily Trading Workflow Failed - ${{ github.run_number }}"
        to: ${{ secrets.EMAIL_TO }}
        from: Trading System
        body: |
          Daily Trading Execution Failed
          
          Run: ${{ github.run_number }}
          Date: ${{ github.event.repository.updated_at }}
          Workflow: ${{ github.workflow }}
          
          Failed Step: Check the logs at:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please review the failure and take corrective action.
          
          Artifacts (if any): daily-artifacts-${{ github.run_number }}
