name: Phase 5 Morning Execution

on:
  schedule:
    # Runs at 6:30 AM PST (14:30 UTC) every day
    - cron: '30 14 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  morning-execution:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Import check
      run: |
        python3 scripts/import_check.py
    
    - name: Initialize database
      run: |
        python scripts/setup_database.py --db trading.db
    
    - name: Update market data
      env:
        ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      run: |
        python scripts/fetch_historical_data.py
    
    - name: Step 1 - Verify positions cleared
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_PAPER: true
      run: |
        max_attempts=3
        attempt=1
        while [ "$attempt" -le "$max_attempts" ]; do
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          from broker_reconciler import BrokerReconciler

          r = BrokerReconciler()
          s = r.get_broker_state()
          print(f'Positions: {len(s[\"positions\"])}')
          print(f'Cash: \${s[\"cash\"]:,.2f}')

          if len(s['positions']) == 0:
              print('âœ… READY FOR DAY 1')
              sys.exit(0)
          else:
              print(f'âš ï¸ {len(s[\"positions\"])} positions remain')
              sys.exit(1)
          "
          if [ "$?" -eq 0 ]; then
            exit 0
          fi
          if [ "$attempt" -lt "$max_attempts" ]; then
            echo "â³ Positions still open. Waiting 5 minutes before retry ($attempt/$max_attempts)."
            sleep 300
          fi
          attempt=$((attempt + 1))
        done
        echo "âš ï¸ Positions still open after $max_attempts attempts - aborting"
        exit 1
    
    - name: Step 2 - Run Day 1 execution
      env:
        ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
        ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        ALPACA_PAPER: true
        ENABLE_BROKER_RECONCILIATION: true
      run: |
        python3 src/execution_engine.py
    
    - name: Step 3 - Verify success
      run: |
        python3 -c "
        import json
        from datetime import datetime
        from pathlib import Path
        import sys
        
        date = datetime.now().strftime('%Y-%m-%d')
        json_path = Path(f'artifacts/json/{date}.json')
        
        if json_path.exists():
            with open(json_path) as f:
                data = json.load(f)
            
            # Reconciliation status is in system_health
            system_health = data.get('system_health', {})
            recon = system_health.get('reconciliation_status', 'UNKNOWN')
            discrep = system_health.get('reconciliation_discrepancies', [])
            
            print(f'Reconciliation: {recon}')
            print(f'Discrepancies: {len(discrep)}')
            
            if 'PASS' in recon and len(discrep) == 0:
                print('âœ… DAY 1 COMPLETE - Phase 5 started!')
                sys.exit(0)
            else:
                print('âŒ Reconciliation failed')
                sys.exit(1)
        else:
            print(f'âŒ No artifact found for {date}')
            sys.exit(1)
        "
    
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: phase5-artifacts-${{ github.run_number }}
        path: |
          artifacts/
          logs/
        retention-days: 30
    
    - name: Generate performance chart
      if: success()
      run: |
        python3 scripts/generate_email_chart.py
    
    - name: Generate daily summary
      if: success()
      run: |
        python3 -c "
        import json
        from datetime import datetime
        from pathlib import Path
        
        date = datetime.now().strftime('%Y-%m-%d')
        artifact_path = Path(f'artifacts/json/{date}.json')
        
        if artifact_path.exists():
            with open(artifact_path) as f:
                data = json.load(f)
            
            # Extract key metrics
            trades = data.get('trades', {})
            signals = data.get('signals', {})
            risk = data.get('risk', {})
            positions = data.get('positions', {})
            regime = data.get('regime', {})

            placed_trades = trades.get('placed', []) if isinstance(trades, dict) else trades
            filled_trades = trades.get('filled', []) if isinstance(trades, dict) else []
            trades_display = filled_trades or placed_trades
            open_positions = positions.get('open', []) if isinstance(positions, dict) else positions
            raw_signals = signals.get('raw', {}) if isinstance(signals, dict) else {}
            
            # Calculate summary stats
            total_trades = len(trades_display)
            buy_trades = sum(1 for t in trades_display if t.get('action') == 'BUY')
            sell_trades = sum(1 for t in trades_display if t.get('action') == 'SELL')
            
            # Generate summary
            summary = f'''ğŸ“Š PHASE 5 DAILY DIGEST - {date}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EXECUTION SUMMARY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âœ… Reconciliation: {data.get('system_health', {}).get('reconciliation_status', 'UNKNOWN')}
        ğŸ“ˆ Market Regime: {regime.get('classification', 'unknown').upper()} (VIX: {regime.get('vix', 'N/A')})
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        TRADING ACTIVITY
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Total Trades Executed: {total_trades}
        â€¢ BUY orders: {buy_trades}
        â€¢ SELL orders: {sell_trades}
        
        Signals Generated: {sum(len(items) for items in raw_signals.values())}
        Active Positions: {len(open_positions)}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        TRADES EXECUTED
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '''
            
            if trades_display:
                for i, trade in enumerate(trades_display, 1):
                    summary += f'''
        {i}. {trade.get('action')} {trade.get('shares', 0)} shares of {trade.get('symbol')}
           Strategy: {trade.get('strategy')}
           Price: \${trade.get('price', 0):.2f}
           Order ID: {trade.get('order_id', 'N/A')}
        '''
            else:
                summary += '\nNo trades executed today.\n'
            
            summary += f'''
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        PORTFOLIO RISK
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Portfolio Heat: {risk.get('portfolio_heat', 0):.1f}%
        Daily P&L: \${risk.get('daily_pnl', 0):.2f}
        Max Heat Allowed: {risk.get('max_heat', 30):.0f}%
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        SYSTEM HEALTH
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Runtime: {data.get('system_health', {}).get('runtime_seconds', 0):.1f}s
        Data Freshness: {data.get('system_health', {}).get('data_freshness', 'N/A')}
        Errors: {data.get('system_health', {}).get('error_count', 0)}
        Warnings: {data.get('system_health', {}).get('warning_count', 0)}
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ“ Artifacts: phase5-artifacts-${{ github.run_number }}
        ğŸ“Š Dashboard: http://localhost:8080
        ğŸ”— Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        This is an automated daily digest. No action required.
        '''
            
            # Save summary to file
            with open('/tmp/daily_summary.txt', 'w') as f:
                f.write(summary)
            
            print('Summary generated successfully')
        else:
            print('No artifact found for today')
            exit(1)
        "
    
    - name: Send daily digest email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸ“Š Phase 5 Daily Digest - ${{ github.run_number }}"
        to: ${{ secrets.EMAIL_TO }}
        from: Phase 5 Automation
        body: file:///tmp/daily_summary.txt
    
    - name: Send failure notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âš ï¸ Phase 5 Workflow Failed - ${{ github.run_number }}"
        to: ${{ secrets.EMAIL_TO }}
        from: Phase 5 Automation
        body: |
          Phase 5 Daily Execution Failed
          
          Run: ${{ github.run_number }}
          Date: ${{ github.event.repository.updated_at }}
          Workflow: ${{ github.workflow }}
          
          Failed Step: Check the logs at:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please review the failure and take corrective action.
          
          Artifacts (if any): phase5-artifacts-${{ github.run_number }}
